# traefik-ingress

Это ingress-proxy сервис, который устанавливается на сервер в единственном экземпляре
и служит для обработки всех HTTP запросов и проксировании их на нужный сайт, который
не имеет доступа к 80 и 443 портам. Это нужно, чтобы не приходилось запускать несколько
HTTP серверов на разных публичных портах (81, 82 и т.д.) или иметь один общий HTTP
сервер типа NGINX или APACHE, который распределял бы трафик по нужным контейнерам (так как его сложнее конфигурировать, чем `traefik`).

Плюсы данного решения:
* Все настройки распределения указываются как `label` в контейнере, на который и будет идти трафик
* Конфигурация маскимально простая и при добавлении нового сервиса на сервер не 
требуется перезагрузка, чтобы конфиги применились.
* Замена SSL сертификатов тоже происходит без перезагрузки.

## Установка
* `git clone git@github.com:vansilich/traefik-ingress.git`
* `cp ./traefik/configs/dynamic/internal.example.yaml ./traefik/configs/dynamic/internal.yaml`
* `docker network create ingress_proxy`
* `docker compose build`
* `docker compose up -d`

## Описание
При запуске занимает на сервере 3 порта:
* `80` - редиректит все HTTP запросы на HTTPS
* `82` - HTTP пинг. Используется для healthcheck сервера, например, балансировщиком. Например `GET http://...:82/ping` (где `...` в запросе - IP сервера) - всегда будет возвращать статус 200
* `443` - порт для HTTPS трафика

Сами запросы от Traefik к docker контейнерам проксируются как HTTP (никогда не по HTTPS)

Для того, чтобы Traefik проксировал запросы к нужному контейнеру нужно прописать соответствующие лейблы в конфигурации. Также добавить этот контейнер в сеть `ingress_proxy`

## Конфигурация
Документация по конфигурации: https://doc.traefik.io/traefik  
* `./traefik/configs/traefik.yaml` - статичный конфиг. Обновляется только через перезагрузку
* `./traefik/configs/dynamic/intetnal.yaml` - динамический конфиг. Сюда прописываются пути до файлов сертификатов (какой сертификат к какому сайту Traefik определяет сам)
* `./traefik/certs/` - директория, куда складываются файлы сертификатов

## Обновление сертификатов
* Для начала вставьте файлы сертификата в директорию сертификатов
* Затем в динамическом конфиге перепишите пути с файлов старых сертификатов на новые файлы
* Удалите файлы старого сертификата